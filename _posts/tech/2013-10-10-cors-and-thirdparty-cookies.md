---
layout: post
category : tech
tagline: "CORS and Third-Party Cookies"
tags : [Web]
excerpt: Всегда хотел написать веб приложение в котором клиент полностью отделен от сервера, находится на другом домене и с сервером только по REST общается. Встрял на одной проблеме. Довольно интересной. Рассказываю.
---
![Cookie Monster](/images/cookie-monster.jpg)

Всегда хотел написать веб приложение в котором клиент полностью отделен от сервера, находится на другом домене и с сервером только по REST общается. Встрял на одной проблеме. Довольно интересной.
Решил Я попробовать сделать следущую архитектуру. Веб приложение находится на основном домене, а сервер с логикой располагается на другом.  
Технологии позволяют: [Cross-Origin-Resource-Sharing](https://en.wikipedia.org/wiki/Cross-Origin_Resource_Sharing)  
В результате приложение запрашивает сервер, а он отвечает с заголовками  

```
Access-Control-Allow-Origin: http://your-webapp.com
```

Браузер не ругается. Полет нормальный.

Следующий этап приложения - это авторизация. Как мы знаем, в качестве идентификатора пользователся в вебе используются Cookies. И, вроде они нам подходят.  
Согласно спецификации ([link](http://www.w3.org/TR/cors/)), для использования идентификаторов (credentials) при работе с CORS, нам нужно сделать 

```
invocation.open('GET', url, true);
    invocation.withCredentials = true; # выставить флаг на клиенте
    invocation.onreadystatechange = handler;
    invocation.send(); 
```

```
Access-Control-Allow-Credentials: true # добавить заголовок в ответ на сервере
```

С этого момента становится возможным передача Cookie / Set-Cookie заголовков. В ином случае их отрежет браузер.  
Теперь должно работать. И, даже работает. Но не везде. Далеко не везде.

## Third-Party Cookies
Куки третьей стороны ;) [link](https://en.wikipedia.org/wiki/HTTP_cookie).  
В двух словах: браузер позволяет установить куки для домена, отличного от домена в адресной строке. Это может быть сделано, в результате запроса картинки/скрипта.  
TP Cookies используются компаниями, которые хотят следить за пользователями в интернетах.
И да-да. Кнопка "+1" и "like" тоже следит за нами. Именно с помощью third-party-cookies. А потом удивляешься, почему после того, как ты посмотрел сайт про ремонт, facebook начал тебя объявлениями тематическими заваливать.

## Intersection
В результате. Заголовок ответа сервера, говорит, что "Cookies разрешены". В JS клиента тоже выставлен флаг. 
Но куки не придут, если в браузере включен режим блокировки Third-Party-Cookies.  
"Логично ли это?" - для себя Я пока не определил. Но факт очень интересный.  

## Firefox && Safary
По умолчанию, Third-Party-Cookies запрещены в Firefox & Safary. Текущий архитектурный подход в них не применим.   
Но, стоп. Как же без этого работают встраиваемые виджеты!? Например, виджет Disqus, который можно наблюдать под статьей.  
Ха-ха. А ведь он не работает. Точнее, работает, но не полностью. Не работает OAuth авторизация. Похоже, Disqus, об этом знает ([link](http://help.disqus.com/customer/portal/articles/466235-enabling-cookies)), но ничего сделать не может.

А Я все еще хочу отделить клиент от сервера.  
Буду читать интернеты и смотреть решения.
